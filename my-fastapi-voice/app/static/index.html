<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ضبط و ارسال صدا</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Vazirmatn, IRANSans, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: #0f172a; color: #e2e8f0; margin: 0; padding: 24px;
      display: flex; min-height: 100vh; align-items: center; justify-content: center;
    }
    .card { width: 100%; max-width: 880px; background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 12px; font-size: 22px; }
    p.hint { margin-top: 0; color: #94a3b8; font-size: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin: 16px 0; }
    button { border: 0; border-radius: 12px; padding: 12px 16px; font-size: 15px; cursor: pointer; background: #1f2937; color: #e5e7eb; transition: .15s ease; }
    button:hover:not([disabled]) { transform: translateY(-1px); background: #374151; }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    .accent { background: #2563eb; } .accent:hover:not([disabled]) { background: #1d4ed8; }
    .danger { background: #b91c1c; } .danger:hover:not([disabled]) { background: #991b1b; }
    .success { background: #16a34a; } .success:hover:not([disabled]) { background: #15803d; }
    .status { border-radius: 12px; padding: 12px; background: #0b1220; border: 1px solid #1f2937; color: #cbd5e1; min-height: 48px; white-space: pre-line; }
    audio { width: 100%; margin-top: 8px; display: none; }
    .timer { font-feature-settings: "tnum" 1; font-variant-numeric: tabular-nums; }
    .chip { display: inline-flex; align-items: center; gap: 8px; background: #0b1220; border: 1px solid #1f2937; border-radius: 999px; padding: 8px 12px; color: #cbd5e1; font-size: 13px; }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: #ef4444; box-shadow: 0 0 0 6px rgba(239,68,68,0.08); }
    .dot.idle { background: #64748b; box-shadow: none; }
    .flex { display:flex; align-items:center; gap:10px; justify-content: space-between; }
    .results { margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .result { background: #0b1220; border: 1px solid #1f2937; border-radius: 12px; padding: 12px; }
    .result h3 { margin: 0 0 8px; font-size: 14px; color: #cbd5e1; }
    .result pre { margin: 0; max-height: 280px; overflow: auto; direction: ltr; text-align: left; white-space: pre-wrap; word-break: break-word; }
    .links { margin-top: 8px; font-size: 13px; color: #93c5fd; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ضبط و ارسال صدا</h1>
    <p class="hint">دکمه «شروع ضبط» را بزنید، سپس با «پایان ضبط» متوقف کنید. می‌توانید گوش کنید، حذف کنید و دوباره ضبط کنید، و در نهایت به سرور ارسال کنید.</p>

    <div class="flex">
      <span class="chip"><span id="recDot" class="dot idle"></span><span id="recState">آماده</span></span>
      <span class="timer" id="timer">00:00</span>
    </div>

    <div class="row">
      <button id="startBtn" class="accent">شروع ضبط</button>
      <button id="stopBtn" disabled>پایان ضبط</button>
      <button id="deleteBtn" class="danger" disabled>حذف صدا</button>
      <button id="sendBtn" class="success" disabled>ارسال به سرور</button>
    </div>

    <audio id="player" controls></audio>

    <div id="status" class="status"></div>

    <div id="afterUpload" style="display:none; margin-top:14px;">
      <!-- <div class="links">
        <span>وضعیت: <b id="jobStatus">—</b></span> •
        <a id="logLink" href="#" target="_blank" rel="noopener">مشاهده لاگ</a>
      </div> -->
      <div id="results" class="results"></div>
    </div>
  </div>

<script>
(() => {
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const sendBtn = document.getElementById('sendBtn');
  const player = document.getElementById('player');
  const statusBox = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const recDot = document.getElementById('recDot');
  const recState = document.getElementById('recState');

  const afterUpload = document.getElementById('afterUpload');
  const jobStatusEl = document.getElementById('jobStatus');
  const logLink = document.getElementById('logLink');
  const resultsGrid = document.getElementById('results');

  let stream = null, recorder = null, chunks = [], blob = null, objectUrl = null;
  let timerId = null, startedAt = 0;
  let currentJob = null;

  const preferTypes = [
    'audio/webm;codecs=opus',
    'audio/webm',
    'audio/ogg;codecs=opus',
    'audio/mp4',
    'audio/mpeg'
  ];

  function pickSupportedType() {
    if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) return '';
    for (const t of preferTypes) {
      try { if (MediaRecorder.isTypeSupported(t)) return t; } catch {}
    }
    return '';
  }

  const setStatus = (msg) => statusBox.textContent = msg;
  const setRecordingUI = (on) => {
    if (on) { recDot.classList.remove('idle'); recState.textContent = 'در حال ضبط…'; }
    else    { recDot.classList.add('idle');   recState.textContent = 'آماده'; }
  };

  const formatTime = (ms) => {
    const sec = Math.floor(ms/1000);
    const m = String(Math.floor(sec/60)).padStart(2,'0');
    const s = String(sec%60).padStart(2,'0');
    return `${m}:${s}`;
  };
  function startTimer(){ startedAt = Date.now(); timerEl.textContent='00:00'; timerId=setInterval(()=>timerEl.textContent=formatTime(Date.now()-startedAt),250); }
  function stopTimer(){ if (timerId){ clearInterval(timerId); timerId=null; } }

  function resetAudio(){
    if (objectUrl) URL.revokeObjectURL(objectUrl);
    objectUrl=null; blob=null; player.src=''; player.style.display='none';
    deleteBtn.disabled = true; sendBtn.disabled = true;
  }

  async function ensureStream(){
    if (stream) return stream;
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('مرورگر از getUserMedia پشتیبانی نمی‌کند.');
    }
    return await navigator.mediaDevices.getUserMedia({ audio: true });
  }

  async function pollStatusLoop(id, statusUrl, resultsUrl) {
    afterUpload.style.display = 'block';
    logLink.href = `/log/${id}`;
    resultsGrid.innerHTML = '';
    jobStatusEl.textContent = 'در صف';

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    while (true) {
      try {
        const r = await fetch(statusUrl, { cache: 'no-store' });
        const s = await r.json();
        if (!s.ok) throw new Error('وضعیت در دسترس نیست.');
        jobStatusEl.textContent = s.status;

        if (s.status === 'done') {
          const rr = await fetch(resultsUrl, { cache: 'no-store' });
          const data = await rr.json();
          if (data.ok && data.status === 'done') {
            renderResults(id, data.files || []);
            setStatus('پردازش کامل شد.');
          } else {
            setStatus('نتایج آماده نشد.');
          }
          break;
        } else if (s.status === 'error') {
          setStatus((s.error ? 'خطا: ' + s.error : 'خطا در پردازش') + '\nLog را بررسی کنید.');
          break;
        }
      } catch (e) {
        setStatus('خطا در دریافت وضعیت: ' + e.message);
        break;
      }
      await sleep(1200);
    }
  }

  function renderResults(id, files) {
    if (!Array.isArray(files)) files = [];
    resultsGrid.innerHTML = '';
    if (files.length === 0) {
      resultsGrid.innerHTML = '<div class="result"><h3>نتیجه‌ای یافت نشد</h3><pre>هیچ فایل متنی تولید نشد.</pre></div>';
      return;
    }
    for (const f of files) {
      const card = document.createElement('div');
      card.className = 'result';
      const title = document.createElement('h3');
      title.textContent = f.name + (typeof f.size === 'number' ? ` (${f.size}B)` : '');
      const pre = document.createElement('pre');
      pre.textContent = f.text || '';
      const a = document.createElement('a');
      a.href = `/download/${id}/${encodeURIComponent(f.name)}`;
      a.textContent = 'دانلود';
      a.target = '_blank'; a.rel = 'noopener';
      card.appendChild(title);
      card.appendChild(pre);
      card.appendChild(a);
      resultsGrid.appendChild(card);
    }
  }

  // UI actions
  startBtn.addEventListener('click', async () => {
    try {
      setStatus('درخواست دسترسی به میکروفون…');
      stream = await ensureStream();
      const type = pickSupportedType();
      const opts = type ? { mimeType: type } : undefined;
      recorder = new MediaRecorder(stream, opts);
      chunks = [];

      recorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
      recorder.onstop = () => {
        stopTimer(); setRecordingUI(false);
        blob = new Blob(chunks, { type: type || (chunks[0]?.type || 'audio/webm') });
        objectUrl = URL.createObjectURL(blob);
        player.src = objectUrl; player.style.display = 'block';
        deleteBtn.disabled = false; sendBtn.disabled = false;
        setStatus('ضبط به پایان رسید. می‌توانید گوش کنید یا ارسال نمایید.');
      };

      recorder.start();
      startTimer(); setRecordingUI(true);
      setStatus('در حال ضبط… برای توقف، «پایان ضبط» را بزنید.');
      startBtn.disabled = true; stopBtn.disabled = false;
      deleteBtn.disabled = true; sendBtn.disabled = true;
    } catch (err) {
      console.error(err);
      setStatus('خطا در دسترسی/شروع ضبط: ' + err.message + '\nاگر از راه دور باز می‌کنید، حتما HTTPS فعال باشد.');
    }
  });

  stopBtn.addEventListener('click', () => {
    if (recorder && recorder.state === 'recording') {
      recorder.stop();
      stopBtn.disabled = true; startBtn.disabled = false;
    }
  });

  deleteBtn.addEventListener('click', () => {
    resetAudio(); setStatus('صدا حذف شد. می‌توانید دوباره ضبط کنید.');
  });

  sendBtn.addEventListener('click', async () => {
    if (!blob) return;
    try {
      setStatus('در حال ارسال به سرور…'); sendBtn.disabled = true;
      const extFromType = (blob.type || 'audio/webm').split('/').pop().split(';')[0] || 'webm';
      const fileName = `recording_${new Date().toISOString().replaceAll(':','-')}.${extFromType}`;
      const file = new File([blob], fileName, { type: blob.type || 'audio/webm' });
      const fd = new FormData(); fd.append('audio', file);

      const res = await fetch('/upload', { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || 'ارسال ناموفق بود');

      setStatus(`با موفقیت ذخیره شد: ${data.saved_as}\nپردازش آغاز شد…`);
      sendBtn.disabled = false;

      currentJob = { id: data.id, statusUrl: data.status_url, resultsUrl: data.results_url, logUrl: data.log_url };
      pollStatusLoop(currentJob.id, currentJob.statusUrl, currentJob.resultsUrl);
    } catch (err) {
      console.error(err); setStatus('خطا در ارسال: ' + err.message); sendBtn.disabled = false;
    }
  });

  window.addEventListener('beforeunload', () => {
    try { if (recorder && recorder.state === 'recording') recorder.stop(); } catch {}
    if (stream) stream.getTracks().forEach(t => t.stop());
    resetAudio(); stopTimer();
  });
})();
</script>
</body>
</html>
